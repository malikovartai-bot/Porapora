generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

/// Роли пользователя в системе (доступы в портале)
enum UserRole {
  OWNER
  MANAGER
  TECH
  ACTOR
}

enum PersonRole {
  ACTOR
  TECH
  OTHER
}

enum EventType {
  SHOW
  REHEARSAL
}

enum EventStatus {
  DRAFT
  CONFIRMED
  CANCELED
}

enum AttachmentVisibility {
  INTERNAL
  CAST_TECH
}

model User {
  id           String   @id @default(cuid())
  name         String?
  email        String   @unique
  passwordHash String
  role         UserRole

  personId     String?  @unique
  person       Person?  @relation(fields: [personId], references: [id])

  attachments  Attachment[]
  createdAt    DateTime @default(now())
}

model Play {
  id          String       @id @default(cuid())
  title       String
  description String?
  events      Event[]
  attachments Attachment[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  /// Роли спектакля (как сущности, не enum)
  roles       PlayRole[]
}

model Venue {
  id        String   @id @default(cuid())
  title     String
  address   String?
  notes     String?
  events    Event[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Person {
  id          String       @id @default(cuid())
  fullName    String
  role        PersonRole
  phone       String?
  email       String?
  notes       String?
  user        User?
  assignments Assignment[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  externalBookings ExternalBooking[]

}

model Event {
  id          String       @id @default(cuid())
  type        EventType
  title       String
  startAt     DateTime
  endAt       DateTime?
  playId      String?
  venueId     String?
  play        Play?        @relation(fields: [playId], references: [id])
  venue       Venue?       @relation(fields: [venueId], references: [id])
  status      EventStatus
  notes       String?
  assignments Assignment[]
  attachments Attachment[]
  financeReportLines FinanceReportLine[]
  expenses    EventExpense[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Assignment {
  id        String   @id @default(cuid())
  eventId   String
  personId  String

  /// роль спектакля (сущность), чтобы назначать людей на конкретные роли
  roleId    String?
  role      PlayRole? @relation(fields: [roleId], references: [id])

  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  person    Person   @relation(fields: [personId], references: [id])

  /// временно оставляем (можно потом убрать/заменить)
  jobTitle  String?
  callTime  DateTime?
  notes     String?
  createdAt DateTime @default(now())

  @@unique([eventId, roleId])
}

model Attachment {
  id               String               @id @default(cuid())
  filename         String
  originalName     String
  mimeType         String
  size             Int
  storagePath      String
  visibility       AttachmentVisibility
  playId           String?
  eventId          String?
  uploadedByUserId String
  uploadedBy       User                 @relation(fields: [uploadedByUserId], references: [id])
  play             Play?                @relation(fields: [playId], references: [id])
  event            Event?               @relation(fields: [eventId], references: [id])
  createdAt        DateTime             @default(now())
}

/// Роль в конкретном спектакле (Марат, Лика, Леонидик и т.д.)
model PlayRole {
  id        String   @id @default(cuid())
  playId    String
  title     String
  sortOrder Int      @default(0)
  notes     String?
  createdAt DateTime @default(now())

  play        Play        @relation(fields: [playId], references: [id], onDelete: Cascade)
  assignments Assignment[]

  @@index([playId])
  @@unique([playId, title])
}

model ExternalBooking {
  id        String   @id @default(cuid())
  personId  String
  title     String
  startAt   DateTime
  endAt     DateTime?
  notes     String?
  createdAt DateTime @default(now())

  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@index([personId, startAt])
}

// === FINANCE REPORTS (Intickets import + manual expenses) ===

enum FinanceProvider {
  INTICKETS
  OTHER
}

enum ExpenseCategory {
  HONORARIUM  // гонорары
  DELIVERY    // доставка / логистика
  BUFFET      // буфет / кейтеринг
  RENT        // аренда
  PROPS       // реквизит / материалы
  COSTUME     // костюм
  MARKETING   // реклама
  OTHER       // прочее
}

model FinanceReport {
  id              String          @id @default(cuid())
  provider        FinanceProvider @default(INTICKETS)

  // SHA-256 хеш содержимого файла, чтобы не импортировать один и тот же отчёт повторно
  contentHash     String?         @unique

  // Метаданные из файла (если найдём)
  reportNo        String?
  contractNo      String?
  reportDate      DateTime?
  periodStart     DateTime?
  periodEnd       DateTime?

  // Итоги по отчёту (если найдём)
  grossSales      Decimal?        @db.Decimal(12, 2)
  serviceFee      Decimal?        @db.Decimal(12, 2)
  refundsAmount   Decimal?        @db.Decimal(12, 2)
  netToOrganizer  Decimal?        @db.Decimal(12, 2)

  // Файл (пока отдельно, позже можем связать с Attachment)
  fileOriginalName String
  fileStoragePath  String
  mimeType         String?
  size             Int?

  lines           FinanceReportLine[]

  createdAt       DateTime        @default(now())
}

model FinanceReportLine {
  id              String        @id @default(cuid())
  reportId        String
  report          FinanceReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // Из таблицы "1. ... реализованы билеты"
  playTitle       String
  sessionAt       DateTime
  canceledInfo    String?

  ticketsCount    Int
  grossAmount     Decimal       @db.Decimal(12, 2)

  servicePercent  Decimal?      @db.Decimal(5, 2)
  partnerPercent  Decimal?      @db.Decimal(5, 2)

  // Привязка к нашему Event (сначала null, после матчинга заполним)
  eventId         String?
  event           Event?        @relation(fields: [eventId], references: [id], onDelete: SetNull)

  createdAt       DateTime      @default(now())

  @@index([sessionAt])
  @@index([eventId])
}

model EventExpense {
  id          String          @id @default(cuid())
  eventId     String
  event       Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)

  category    ExpenseCategory
  title       String
  amount      Decimal         @db.Decimal(12, 2)
  notes       String?

  createdAt   DateTime        @default(now())

  @@index([eventId])
  @@index([category])
}


enum EventExpenseCategory {
  RENT
  SALARY
  TRANSPORT
  SET
  COSTUME
  MARKETING
  PRINT
  FOOD
  OTHER
}

